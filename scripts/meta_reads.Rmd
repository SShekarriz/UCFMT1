---
title: "Metagenomic_reads"
author: "Sharok"
date: "4/28/2023"
output: html_document
---

```{r}

library(tidyverse)
library(tidytext)
proj="~/Drive2/UC_FMT1/UC_FMT1_github/"

```

```{r}
mapfile <- read.csv(paste(proj, "data/UCFMT1_METAmap.txt", sep = ""),
                    sep = "\t")

```

## Marker-level analysis
Reading marker abundance files, parse them into one
```{r}
path=paste(proj, "data/Metaphlan4/marker_abund", sep = "")
#outpath="metaphlan4"
data.frame(sample.id = paste(dir(path,
                                 pattern = "*_abund_norm.txt"))) %>%
# read each file from the directory (current path) and then unnest
mutate(file_contents = map(sample.id, ~ read.csv(file.path(path, .),
                                                 sep = "\t", header = F,
                                                 comment.char = "#"))) %>%
unnest() %>%
mutate(sample.id= gsub(".marker_abund_norm.txt", "", sample.id)) %>%
  spread(sample.id, V2) %>%
  rename(Marker="V1") %>%
  mutate(temp=Marker) %>%
  separate(temp, c("sp_marker", "temp1", "temp2"), sep = "__") %>%
  mutate(st_marker= case_when(!is.na(temp2) ~ paste(temp1, temp2, sep = "__"),
                              TRUE ~ paste(temp1))) %>%
  select(sp_marker, st_marker, Marker, DonorB_D_2013:PMCL883)-> marker_lvl


```


```{r}

################################################################################
# a function to detect common engraftment based on strains (metaphlan markers)
################################################################################
stCE <- function(marker_lvl, mapfile, strains, cutoff=cutoff, ...){
  # convert marker-lvl to long format, make Study_ID variable (in mapfile),
  # and select only donor's strains
  marker_lvl %>%
  filter(Marker %in% strains) %>%
  select( -sp_marker, -st_marker) %>%
  gather(sample, abundance, -Marker) %>%
  mutate(Study_ID = case_when(
    str_detect(sample,"PMCL") ~ paste(gsub("_.*", "",sample)),
    TRUE ~ paste(sample))) -> long_markerlvl
  # complete list of engrafted
  long_markerlvl %>%
    left_join(mapfile) %>%
    filter(...) %>%
    spread(Timepoint, abundance, fill = 0) %>%
    mutate(model= case_when(WK0 <= 0 & WK6 > cutoff ~ paste("Engraft"),
                          TRUE ~ paste("other"))) %>%
    filter(model == "Engraft") %>%
    select(Marker, Study_ID, WK6) %>%
    spread(Study_ID, WK6, fill = 0) -> engraft
  # number of samples in input table
  engraft %>%
    gather(sample, abund, -Marker) %>% 
    pull(sample) %>% n_distinct() -> number_of_samples
  # for loop for engraftment across increasing number of patients
  Emark.1 <- list()
  Emark.2 <- list()
  for (i in 1:number_of_samples) {
  Emark.1[[i]] <- engraft[rowSums(engraft[,2:ncol(engraft)] > 0) >= i, ]
  Emark.2[[i]] <- data_frame(Npts = paste(i),
                             E.strains = length(Emark.1[[i]]$Marker))
  }
  do.call(rbind.data.frame, Emark.2)
}
################################################################################
################################################################################

```


commonly engraftment of markers:
```{r}

marker_lvl %>%
  gather(sample, abundance, -sp_marker, -st_marker, -Marker) %>%
  #filtering donor B markers
  filter(str_detect(sample, "DonorB_D_")) %>%
  #any marker with abundance > 0
  #markers that were present in at least one donor B sample
  filter(!is.na(abundance)) %>%
  filter(as.numeric(abundance) > 0) -> donorB_markers

donorB_markers %>%
  select(Marker) %>% distinct() %>%
  pull() -> B_markers

##### seting engraftment cut-off
donorB_markers %>%
  group_by(sample) %>%
  # minimum detection in each donor B sample
  slice(which.min(abundance)) -> min_B_markers
  # average of minimum detections-> test
cutoff= mean(min_B_markers$abundance)
######

######### common engraftment for FMT ###############################
stCE(marker_lvl, mapfile, strains = B_markers, cutoff = cutoff,
     Treatment == "FMT") -> commonE_FMT
######### common engraftment for Placebo ############################
stCE(marker_lvl, mapfile, strains = B_markers, cutoff = cutoff,
     Treatment == "Placebo") -> commonE_Placebo
######### common engraftment for Responder #########################
stCE(marker_lvl, mapfile, strains = B_markers, cutoff = cutoff,
     Treatment == "FMT" & Remission == "Res") -> commonE_FMTRes
######### common engraftment for Non-responder #####################
stCE(marker_lvl, mapfile, strains = B_markers, cutoff = cutoff,
     Treatment == "FMT" & Remission == "NoRes") -> commonE_FMTNoRes

######################################################
########### visualizing
######################################################

cols1 <- c("FMT" = "#008837",
           "Placebo" = "#bdbdbd",
           "Responder" = "#0571b0",
           "Non-Responder" = "#ca0020")

commonE_FMT %>% 
  mutate(Type=paste("FMT"),
          Samples= "All") %>%
  bind_rows(commonE_Placebo %>% 
             mutate(Type=paste("Placebo"),
                    Samples="All")) %>%
  bind_rows(commonE_FMTRes %>%
              mutate(Type="Responder",
                     Samples="onlyFMT")) %>%
  bind_rows(commonE_FMTNoRes %>%
              mutate(Type="Non-Responder",
                     Samples="onlyFMT")) -> tbl

tbl$Type <- factor(tbl$Type, levels = c("FMT", "Placebo", 
                                        "Responder", "Non-Responder"))
ggplot(tbl, aes(as.numeric(Npts), E.strains, color=Type)) +
  geom_line(aes(group=Type))+
  #facet_grid(~Samples, space = "free") +
  scale_y_log10() +
  scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6, 7,8,9,10,11,12)) +
  scale_color_manual(values = cols1) +
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.position = c("0.8", "0.8")) +
  xlab("Increasing # of patients") +
  ylab("# of engrafted Strains")
ggsave(paste(proj, "figs/CESt.png", sep = ""),
       width = 10, height = 8, units = "cm")

```
